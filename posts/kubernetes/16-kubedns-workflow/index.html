<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理 -</title><meta name=Description content="k8s 中的 kubedns 是如何工作的，如何将 service DNS 记录解析为 IP 地址的"><meta property="og:title" content="Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理"><meta property="og:description" content="k8s 中的 kubedns 是如何工作的，如何将 service DNS 记录解析为 IP 地址的"><meta property="og:type" content="article"><meta property="og:url" content="https://www.lixueduan.com/posts/kubernetes/16-kubedns-workflow/"><meta property="og:image" content="https://www.lixueduan.com/img/jinx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-25T00:00:00+00:00"><meta property="og:site_name" content="意琦行的个人博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lixueduan.com/img/jinx.png"><meta name=twitter:title content="Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理"><meta name=twitter:description content="k8s 中的 kubedns 是如何工作的，如何将 service DNS 记录解析为 IP 地址的"><meta name=application-name content="指月小筑"><meta name=apple-mobile-web-app-title content="指月小筑"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.lixueduan.com/posts/kubernetes/16-kubedns-workflow/><link rel=prev href=https://www.lixueduan.com/posts/cloudnative/01-metallb/><link rel=next href=https://www.lixueduan.com/posts/docker/11-use-ssh-private-key-in-docker-build/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.lixueduan.com\/posts\/kubernetes\/16-kubedns-workflow\/"},"image":["https:\/\/www.lixueduan.com\/img\/jinx.png"],"genre":"posts","keywords":"Kubernetes","wordcount":5871,"url":"https:\/\/www.lixueduan.com\/posts\/kubernetes\/16-kubedns-workflow\/","datePublished":"2023-02-25T00:00:00+00:00","dateModified":"2023-02-25T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"意琦行"},"description":"k8s 中的 kubedns 是如何工作的，如何将 service DNS 记录解析为 IP 地址的"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title>指月小筑</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=指月小筑>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title>指月小筑</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=指月小筑>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/lixd title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>意琦行</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>Kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-25>2023-02-25</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;5871 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;12 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-coredns-与-kubedns>1. CoreDNS 与 KubeDNS</a></li><li><a href=#2-coredns-是如何解析请求的>2. CoreDNS 是如何解析请求的</a><ul><li><a href=#corefile>Corefile</a></li><li><a href=#kubernetes-插件做了什么>Kubernetes 插件做了什么</a></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#3-pod-如何知道要把请求发给-coredns>3. Pod 如何知道要把请求发给 CoreDNS</a><ul><li><a href=#pod-dnsconfig>Pod DNSConfig</a></li><li><a href=#配置来源>配置来源</a></li><li><a href=#kubelet>Kubelet</a></li><li><a href=#为什么是-1096010>为什么是 10.96.0.10</a></li></ul></li><li><a href=#4-小结>4. 小结</a></li></ul></nav></div></div><div class=content id=content><p>本文主要记录了 k8s 中的 kubedns 是如何工作的，如何将 service DNS 记录解析为 IP 地址的。包括 CoreDNS 如何解析请求的，具体的数据来源以及处理逻辑，同时 Pod 又是怎么知道要把 DNS 解析请求发送给 CoreDNS 的等等问题。</p><h2 id=1-coredns-与-kubedns>1. CoreDNS 与 KubeDNS</h2><p>CoreDNS 是一个 Go 语言实现的 DNS Server，通过 <strong>链式插件(chains plugins)</strong> 实现的，因此用户可以很轻松的以添加插件的方式在实现自定义逻辑。同时 CoreDNS 也是一个 CNCF 的毕业项目，稳定性、可用性方面不用担心。</p><p><strong>什么需要 KubeDNS 组件</strong></p><p>Kubernetes Service 通过虚拟 IP 地址或者节点端口为用户应用提供访问入口，然而这些 IP 地址和端口是动态分配的，实际项目中无法把一个可变的入口发布出去供用户访问。为了解决这个问题，Kubernetes 提供了内置的域名服务，用户定义的服务会自动获取域名，通过域名解析，可以对外向用户提供一个固定的服务访问地址。</p><p>最初 k8s 使用自定义组件 KubDNS 来实现，不过从 K8S 1.11 开始，K8S 已经使用 CoreDNS，替换 KubeDNS 来充当其 DNS 解析的重任。</p><p>为了搞清楚 k8s 中的 KubeDNS 组件工作原理，我们需要清楚下面两个问题：</p><ul><li>1）<strong>CoreDNS 是如何解析请求的</strong><ul><li>CoreDNS 怎么知道 service 域名和 clusterIP 或者 externalIP 的对应关系的，数据是从哪儿来的呢</li></ul></li><li>2）<strong>Pod 如何知道要把请求发给 CoreDNS</strong><ul><li>Pod 里的 DNS 配置是怎么样的，又是什么时候生成的等等</li></ul></li></ul><p>首先我们需要一个 k8s 集群，单节点即可。</p><p>如果没有 k8s 环境的话可以参数这篇文章：<a href=https://www.lixueduan.com/posts/kubernetes/11-install-by-kubeclipper/ target=_blank rel="noopener noreffer">Kubernetes教程(十一)—使用 KubeClipper 通过一条命令快速创建 k8s 集群</a>，快速搭建一个。</p><h2 id=2-coredns-是如何解析请求的>2. CoreDNS 是如何解析请求的</h2><h3 id=corefile>Corefile</h3><p>首先要从 CoreDNS 的配置文件，Corefile 说起。</p><p>集群搭建好后，里面会启动两个叫做 coredns 的 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@test ~<span class=o>]</span><span class=c1># kubectl -n kube-system get po</span>
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS        AGE
</span></span><span class=line><span class=cl>calico-kube-controllers-6c557bcb96-kxlp8   1/1     Running   <span class=m>0</span>               5d19h
</span></span><span class=line><span class=cl>calico-node-rd28x                          1/1     Running   <span class=m>0</span>               5d19h
</span></span><span class=line><span class=cl>coredns-84798fc4bb-8rrzz                   1/1     Running   <span class=m>0</span>               4d22h
</span></span><span class=line><span class=cl>coredns-84798fc4bb-sbtdr                   1/1     Running   <span class=m>0</span>               4d22h
</span></span><span class=line><span class=cl>etcd-test                                  1/1     Running   <span class=m>0</span>               5d19h
</span></span><span class=line><span class=cl>kc-kubectl-7f854bbd9b-mfdl7                1/1     Running   <span class=m>0</span>               5d19h
</span></span><span class=line><span class=cl>kube-apiserver-test                        1/1     Running   <span class=m>0</span>               5d19h
</span></span><span class=line><span class=cl>kube-controller-manager-test               1/1     Running   <span class=m>9</span> <span class=o>(</span>2d12h ago<span class=o>)</span>   5d19h
</span></span><span class=line><span class=cl>kube-proxy-2zcch                           1/1     Running   <span class=m>0</span>               5d19h
</span></span><span class=line><span class=cl>kube-scheduler-test                        1/1     Running   <span class=m>9</span> <span class=o>(</span>2d12h ago<span class=o>)</span>   5d19h
</span></span></code></pre></div><p>可以看到在 kube-system namespace 下有两个 CoreDNS pod，而配置文件则来源于 Configmap，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@test ~<span class=o>]</span><span class=c1># kubectl -n kube-system get cm</span>
</span></span><span class=line><span class=cl>NAME                                 DATA   AGE
</span></span><span class=line><span class=cl>calico-config                        <span class=m>4</span>      5d19h
</span></span><span class=line><span class=cl>coredns                              <span class=m>1</span>      5d19h
</span></span><span class=line><span class=cl>extension-apiserver-authentication   <span class=m>6</span>      5d19h
</span></span><span class=line><span class=cl>kube-proxy                           <span class=m>2</span>      5d19h
</span></span><span class=line><span class=cl>kube-root-ca.crt                     <span class=m>1</span>      5d19h
</span></span><span class=line><span class=cl>kubeadm-config                       <span class=m>1</span>      5d19h
</span></span><span class=line><span class=cl>kubelet-config-1.23                  <span class=m>1</span>      5d19h
</span></span></code></pre></div><p>具体内容如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@test ~<span class=o>]</span><span class=c1># kubectl -n kube-system get cm  coredns -oyaml</span>
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  Corefile: <span class=p>|</span>-
</span></span><span class=line><span class=cl>    .:53 <span class=o>{</span>
</span></span><span class=line><span class=cl>        errors
</span></span><span class=line><span class=cl>        health <span class=o>{</span>
</span></span><span class=line><span class=cl>            lameduck 5s
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        ready
</span></span><span class=line><span class=cl>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=o>{</span>
</span></span><span class=line><span class=cl>            pods insecure
</span></span><span class=line><span class=cl>            fallthrough in-addr.arpa ip6.arpa
</span></span><span class=line><span class=cl>            ttl <span class=m>30</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        prometheus :9153
</span></span><span class=line><span class=cl>        forward . /etc/resolv.conf
</span></span><span class=line><span class=cl>        cache <span class=m>10</span>
</span></span><span class=line><span class=cl>        loop
</span></span><span class=line><span class=cl>        reload 10s
</span></span><span class=line><span class=cl>        loadbalance
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  creationTimestamp: <span class=s2>&#34;2023-02-27T06:47:05Z&#34;</span>
</span></span><span class=line><span class=cl>  name: coredns
</span></span><span class=line><span class=cl>  namespace: kube-system
</span></span><span class=line><span class=cl>  resourceVersion: <span class=s2>&#34;187919&#34;</span>
</span></span><span class=line><span class=cl>  uid: 76f7a78f-70ce-4074-9660-aa317cc7c1c1
</span></span></code></pre></div><p>其中 data.Corefile 字段就是 CoreDNS 的配置文件，</p><pre tabindex=0><code class=language-Corefile data-lang=Corefile>.:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 10
        loop
        reload 10s
        loadbalance
    }
</code></pre><p>具体内容大致解释一下：</p><ul><li><code>.:53</code> 表示在 53 端口监听服务,<code>.</code> 表示任意的域名都由该服务来处理<ul><li>可以启动多个服务，因此需要用域名来区分，比如<code>a.com:53</code>、<code>b.com:5300</code> 就分别在不同端口启动了两个服务，每个服务只会处理各自域名下的 DNS 请求</li></ul></li></ul><p>后续大括号里的就是启动的插件，前面说过 CoreDNS 是链式插件组成的，而具体启动哪些插件则是由配置文件决定的。</p><p>比如 errors 则表示开启 errors 插件，用于记录错误，health 则开启健康检测插件，其他插件同理。</p><p><strong>最重要的是 kubernetes 这个，开启了一个叫做 kubernetes 的插件。</strong></p><p>这个就是 k8s 官方维护的一个 CoreDNS 插件，就是依靠该插件 CoreDNS 才实现了 KubeDNS 需要的功能，因此自然需要分析一下这个插件做了什么。</p><blockquote><p>该插件源码存放在 coredns 仓库里，具体见<a href=https://github.com/coredns/coredns/tree/master/plugin/kubernetes target=_blank rel="noopener noreffer">plugin/kubernetes</a></p></blockquote><h3 id=kubernetes-插件做了什么>Kubernetes 插件做了什么</h3><p>CoreDNS 正是通过 kubernetes 插件实现了解析 k8s 集群内域名的功能。那么我们看下这个插件做了些什么事情。</p><blockquote><p>剧透一下：该插件主要调用 k8s api 获取 service、endpoint 等信息，然后组装成 dns 格式数据用以处理客户端 dns 解析请求。</p></blockquote><h4 id=插件初始化>插件初始化</h4><p>插件的初始化方法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// plugin/kubernetes/setup.go#33
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>setup</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>caddy</span><span class=p>.</span><span class=nx>Controller</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Do not call klog.InitFlags(nil) here.  It will cause reload to panic.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>klog</span><span class=p>.</span><span class=nf>SetOutput</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 检查了 corefile 中 kubernetes 配置的定义，并配置了一些缺省值
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>k</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>kubernetesParse</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>plugin</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>pluginName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动了对 pod, service, endpoint 三种资源增、删、改的 watch，并注册了一些回调
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 注意：pod 是否启动 watch 是根据配置文件中 pod 的值来决定的，如果值不是 verified 就不会启动 pod 的 watch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这里的 watch 方法观测到变化后，仅仅只改变 dns.modified 这个值，它会将该值设置为当前时间戳
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>onStart</span><span class=p>,</span> <span class=nx>onShut</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>k</span><span class=p>.</span><span class=nf>InitKubeCache</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>plugin</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>pluginName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>onStart</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>c</span><span class=p>.</span><span class=nf>OnStartup</span><span class=p>(</span><span class=nx>onStart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>onShut</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>c</span><span class=p>.</span><span class=nf>OnShutdown</span><span class=p>(</span><span class=nx>onShut</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 添加插件到插件链里
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>dnsserver</span><span class=p>.</span><span class=nf>GetConfig</span><span class=p>(</span><span class=nx>c</span><span class=p>).</span><span class=nf>AddPlugin</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>next</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>k</span><span class=p>.</span><span class=nx>Next</span> <span class=p>=</span> <span class=nx>next</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>k</span>
</span></span><span class=line><span class=cl>   <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// get locally bound addresses
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>c</span><span class=p>.</span><span class=nf>OnStartup</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>k</span><span class=p>.</span><span class=nx>localIPs</span> <span class=p>=</span> <span class=nf>boundIPs</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>   <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><em>以下这三个方法就是 watch 资源时的回调</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>//plugin/kubernetes/controller.go#563
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>dns</span> <span class=o>*</span><span class=nx>dnsControl</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>               <span class=p>{</span> <span class=nx>dns</span><span class=p>.</span><span class=nf>updateModified</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>dns</span> <span class=o>*</span><span class=nx>dnsControl</span><span class=p>)</span> <span class=nf>Delete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>            <span class=p>{</span> <span class=nx>dns</span><span class=p>.</span><span class=nf>updateModified</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>dns</span> <span class=o>*</span><span class=nx>dnsControl</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span> <span class=nx>dns</span><span class=p>.</span><span class=nf>detectChanges</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// updateModified set dns.modified to the current time.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>dns</span> <span class=o>*</span><span class=nx>dnsControl</span><span class=p>)</span> <span class=nf>updateModified</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>unix</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Unix</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=nx>atomic</span><span class=p>.</span><span class=nf>StoreInt64</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>dns</span><span class=p>.</span><span class=nx>modified</span><span class=p>,</span> <span class=nx>unix</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// updateExtModified set dns.extModified to the current time.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>dns</span> <span class=o>*</span><span class=nx>dnsControl</span><span class=p>)</span> <span class=nf>updateExtModifed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>unix</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Unix</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=nx>atomic</span><span class=p>.</span><span class=nf>StoreInt64</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>dns</span><span class=p>.</span><span class=nx>extModified</span><span class=p>,</span> <span class=nx>unix</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// detectChanges detects changes in objects, and updates the modified timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>dns</span> <span class=o>*</span><span class=nx>dnsControl</span><span class=p>)</span> <span class=nf>detectChanges</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// If both objects have the same resource version, they are identical.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>newObj</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>oldObj</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>oldObj</span><span class=p>.(</span><span class=nx>meta</span><span class=p>.</span><span class=nx>Object</span><span class=p>).</span><span class=nf>GetResourceVersion</span><span class=p>()</span> <span class=o>==</span> <span class=nx>newObj</span><span class=p>.(</span><span class=nx>meta</span><span class=p>.</span><span class=nx>Object</span><span class=p>).</span><span class=nf>GetResourceVersion</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>obj</span> <span class=o>:=</span> <span class=nx>newObj</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>obj</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>obj</span> <span class=p>=</span> <span class=nx>oldObj</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>switch</span> <span class=nx>ob</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Service</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>imod</span><span class=p>,</span> <span class=nx>emod</span> <span class=o>:=</span> <span class=nf>serviceModified</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>imod</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>dns</span><span class=p>.</span><span class=nf>updateModified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>emod</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>dns</span><span class=p>.</span><span class=nf>updateExtModifed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Pod</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>dns</span><span class=p>.</span><span class=nf>updateModified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>!</span><span class=nf>endpointsEquivalent</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>.(</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>),</span> <span class=nx>newObj</span><span class=p>.(</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>dns</span><span class=p>.</span><span class=nf>updateModified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>log</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;Updates for %T not supported.&#34;</span><span class=p>,</span> <span class=nx>ob</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到，不管是 add、update 还是 delete，最终都是调用 updateModified 或者 updateExtModifed 方法来修改对应字段，并没有把新的 svc 或者 endpoint 这些记录下来。</p><p>按照正常情况不是应该 watch 变化，然后在内存里维护一份数据，用于在外部 DNS 请求时查询吗。</p><p>实际上这里也存了，不过是<strong>复用了</strong> <strong><code>client-go</code></strong> <strong>中的</strong> <strong><code>informer</code></strong> <strong>机制</strong>，informer 会在内存中存储 watch 的对象，因此 service、endpoint、pod 这些数据内存里都是有的，插件这边就不用额外存一份了。</p><blockquote><p>准确的说是 client-go 中的 Indexer 组件，它已经将所有 watch 的对象在本地内存中存储了一份。</p></blockquote><h4 id=如何处理解析请求>如何处理解析请求</h4><p>插件里使用 Services 方法来处理所有接收到的 DNS 请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// plugin/kubernetes/kubernetes.go#95
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>k</span> <span class=o>*</span><span class=nx>Kubernetes</span><span class=p>)</span> <span class=nf>Services</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=nx>request</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>exact</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>opt</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>Options</span><span class=p>)</span> <span class=p>(</span><span class=nx>svcs</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// We&#39;re looking again at types, which we&#39;ve already done in ServeDNS, but there are some types k8s just can&#39;t answer.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>switch</span> <span class=nx>state</span><span class=p>.</span><span class=nf>QType</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 如果是插件 DNS 服务版本的话就返回编译时的版本号
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>case</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeTXT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 1 label + zone, label must be &#34;dns-version&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>t</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>dnsutil</span><span class=p>.</span><span class=nf>TrimZone</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Zone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>segs</span> <span class=o>:=</span> <span class=nx>dns</span><span class=p>.</span><span class=nf>SplitDomainName</span><span class=p>(</span><span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>segs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>segs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=s>&#34;dns-version&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>svc</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Text</span><span class=p>:</span> <span class=nx>DNSSchemaVersion</span><span class=p>,</span> <span class=nx>TTL</span><span class=p>:</span> <span class=mi>28800</span><span class=p>,</span> <span class=nx>Key</span><span class=p>:</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nf>QName</span><span class=p>(),</span> <span class=nx>coredns</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>svc</span><span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 如果查询的是 NS 类型记录，就返回 CoreDNS service 自身在集群里的记录
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>case</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeNS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=c1>// We can only get here if the qname equals the zone, see ServeDNS in handler.go.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>nss</span> <span class=o>:=</span> <span class=nx>k</span><span class=p>.</span><span class=nf>nsAddrs</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Zone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>svcs</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ns</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nss</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>ns</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Rrtype</span> <span class=o>==</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeA</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>svcs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>svcs</span><span class=p>,</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Host</span><span class=p>:</span> <span class=nx>ns</span><span class=p>.(</span><span class=o>*</span><span class=nx>dns</span><span class=p>.</span><span class=nx>A</span><span class=p>).</span><span class=nx>A</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>Key</span><span class=p>:</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=nx>ns</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>coredns</span><span class=p>),</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>ns</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Rrtype</span> <span class=o>==</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeAAAA</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>svcs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>svcs</span><span class=p>,</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Host</span><span class=p>:</span> <span class=nx>ns</span><span class=p>.(</span><span class=o>*</span><span class=nx>dns</span><span class=p>.</span><span class=nx>AAAA</span><span class=p>).</span><span class=nx>AAAA</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>Key</span><span class=p>:</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=nx>ns</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>coredns</span><span class=p>),</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>})</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>svcs</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nf>isDefaultNS</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Zone</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>nss</span> <span class=o>:=</span> <span class=nx>k</span><span class=p>.</span><span class=nf>nsAddrs</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Zone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>svcs</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ns</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nss</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>ns</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Rrtype</span> <span class=o>==</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeA</span> <span class=o>&amp;&amp;</span> <span class=nx>state</span><span class=p>.</span><span class=nf>QType</span><span class=p>()</span> <span class=o>==</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeA</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>svcs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>svcs</span><span class=p>,</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Host</span><span class=p>:</span> <span class=nx>ns</span><span class=p>.(</span><span class=o>*</span><span class=nx>dns</span><span class=p>.</span><span class=nx>A</span><span class=p>).</span><span class=nx>A</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>Key</span><span class=p>:</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nf>QName</span><span class=p>(),</span> <span class=nx>coredns</span><span class=p>),</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>ns</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Rrtype</span> <span class=o>==</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeAAAA</span> <span class=o>&amp;&amp;</span> <span class=nx>state</span><span class=p>.</span><span class=nf>QType</span><span class=p>()</span> <span class=o>==</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeAAAA</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>svcs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>svcs</span><span class=p>,</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Host</span><span class=p>:</span> <span class=nx>ns</span><span class=p>.(</span><span class=o>*</span><span class=nx>dns</span><span class=p>.</span><span class=nx>AAAA</span><span class=p>).</span><span class=nx>AAAA</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>Key</span><span class=p>:</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nf>QName</span><span class=p>(),</span> <span class=nx>coredns</span><span class=p>),</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>})</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>svcs</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 到这里才正式开始解析 DNS 请求
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>s</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>k</span><span class=p>.</span><span class=nf>Records</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// SRV for external services is not yet implemented, so remove those records.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>state</span><span class=p>.</span><span class=nf>QType</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeSRV</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>s</span><span class=p>,</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>internal</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>svc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>t</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>svc</span><span class=p>.</span><span class=nf>HostType</span><span class=p>();</span> <span class=nx>t</span> <span class=o>!=</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeCNAME</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>internal</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>internal</span><span class=p>,</span> <span class=nx>svc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>internal</span><span class=p>,</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Record 方法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// plugin/kubernetes/kubernetes.go#370
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>k</span> <span class=o>*</span><span class=nx>Kubernetes</span><span class=p>)</span> <span class=nf>Records</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=nx>request</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>exact</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>([]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 将请求数据解析为service、namespace 之类的格式
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>r</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nf>parseRequest</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Zone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 数据异常直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>podOrSvc</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>dnsutil</span><span class=p>.</span><span class=nf>IsReverse</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nf>Name</span><span class=p>())</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>!</span><span class=nx>k</span><span class=p>.</span><span class=nf>namespaceExposed</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>namespace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNsNotExposed</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 查询 pod 
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>podOrSvc</span> <span class=o>==</span> <span class=nx>Pod</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pods</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>k</span><span class=p>.</span><span class=nf>findPods</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Zone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>pods</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 查询 svc
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>services</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>k</span><span class=p>.</span><span class=nf>findServices</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Zone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>services</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到，record方法中根据请求是查询 pod 还是查询 service 分别调用了不同的方法。</p><p>pod 的查询方法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// plugin/kubernetes/kubernetes.go#412
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>k</span> <span class=o>*</span><span class=nx>Kubernetes</span><span class=p>)</span> <span class=nf>findPods</span><span class=p>(</span><span class=nx>r</span> <span class=nx>recordRequest</span><span class=p>,</span> <span class=nx>zone</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>pods</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>k</span><span class=p>.</span><span class=nx>podMode</span> <span class=o>==</span> <span class=nx>podModeDisabled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>namespace</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>namespace</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>!</span><span class=nx>k</span><span class=p>.</span><span class=nf>namespaceExposed</span><span class=p>(</span><span class=nx>namespace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>podname</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// handle empty pod name
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>podname</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>k</span><span class=p>.</span><span class=nf>namespaceExposed</span><span class=p>(</span><span class=nx>namespace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// NODATA
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// NXDOMAIN
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>zonePath</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=nx>zone</span><span class=p>,</span> <span class=nx>coredns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>ip</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Count</span><span class=p>(</span><span class=nx>podname</span><span class=p>,</span> <span class=s>&#34;-&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>podname</span><span class=p>,</span> <span class=s>&#34;--&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>ip</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ReplaceAll</span><span class=p>(</span><span class=nx>podname</span><span class=p>,</span> <span class=s>&#34;-&#34;</span><span class=p>,</span> <span class=s>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>ip</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ReplaceAll</span><span class=p>(</span><span class=nx>podname</span><span class=p>,</span> <span class=s>&#34;-&#34;</span><span class=p>,</span> <span class=s>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>k</span><span class=p>.</span><span class=nx>podMode</span> <span class=o>==</span> <span class=nx>podModeInsecure</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>!</span><span class=nx>k</span><span class=p>.</span><span class=nf>namespaceExposed</span><span class=p>(</span><span class=nx>namespace</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// namespace does not exist
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// If ip does not parse as an IP address, we return an error, otherwise we assume a CNAME and will try to resolve it in backend_lookup.go
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=nx>ip</span><span class=p>)</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{{</span><span class=nx>Key</span><span class=p>:</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=nx>zonePath</span><span class=p>,</span> <span class=nx>Pod</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>podname</span><span class=p>},</span> <span class=s>&#34;/&#34;</span><span class=p>),</span> <span class=nx>Host</span><span class=p>:</span> <span class=nx>ip</span><span class=p>,</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>}},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// PodModeVerified
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>err</span> <span class=p>=</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>k</span><span class=p>.</span><span class=nx>APIConn</span><span class=p>.</span><span class=nf>PodIndex</span><span class=p>(</span><span class=nx>ip</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// check for matching ip and namespace
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>ip</span> <span class=o>==</span> <span class=nx>p</span><span class=p>.</span><span class=nx>PodIP</span> <span class=o>&amp;&amp;</span> <span class=nf>match</span><span class=p>(</span><span class=nx>namespace</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>s</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=nx>zonePath</span><span class=p>,</span> <span class=nx>Pod</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>podname</span><span class=p>},</span> <span class=s>&#34;/&#34;</span><span class=p>),</span> <span class=nx>Host</span><span class=p>:</span> <span class=nx>ip</span><span class=p>,</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=nx>pods</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>pods</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nx>err</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>pods</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>service 查询方法如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// findServices returns the services matching r from the cache.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>k</span> <span class=o>*</span><span class=nx>Kubernetes</span><span class=p>)</span> <span class=nf>findServices</span><span class=p>(</span><span class=nx>r</span> <span class=nx>recordRequest</span><span class=p>,</span> <span class=nx>zone</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>services</span> <span class=p>[]</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>!</span><span class=nx>k</span><span class=p>.</span><span class=nf>namespaceExposed</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>namespace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// handle empty service name
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>service</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>k</span><span class=p>.</span><span class=nf>namespaceExposed</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>namespace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// NODATA
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// NXDOMAIN
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>err</span> <span class=p>=</span> <span class=nx>errNoItems</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>endpointsListFunc</span> <span class=kd>func</span><span class=p>()</span> <span class=p>[]</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Endpoints</span>
</span></span><span class=line><span class=cl>      <span class=nx>endpointsList</span>     <span class=p>[]</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Endpoints</span>
</span></span><span class=line><span class=cl>      <span class=nx>serviceList</span>       <span class=p>[]</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Service</span>
</span></span><span class=line><span class=cl>   <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>idx</span> <span class=o>:=</span> <span class=nx>object</span><span class=p>.</span><span class=nf>ServiceKey</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>service</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>namespace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>serviceList</span> <span class=p>=</span> <span class=nx>k</span><span class=p>.</span><span class=nx>APIConn</span><span class=p>.</span><span class=nf>SvcIndex</span><span class=p>(</span><span class=nx>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>endpointsListFunc</span> <span class=p>=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>[]</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Endpoints</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>k</span><span class=p>.</span><span class=nx>APIConn</span><span class=p>.</span><span class=nf>EpIndex</span><span class=p>(</span><span class=nx>idx</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>zonePath</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Path</span><span class=p>(</span><span class=nx>zone</span><span class=p>,</span> <span class=nx>coredns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>svc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>serviceList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>!(</span><span class=nf>match</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>namespace</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nf>match</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>service</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// If &#34;ignore empty_service&#34; option is set and no endpoints exist, return NXDOMAIN unless
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// it&#39;s a headless or externalName service (covered below).
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>k</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>ignoreEmptyService</span> <span class=o>&amp;&amp;</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Type</span> <span class=o>!=</span> <span class=nx>api</span><span class=p>.</span><span class=nx>ServiceTypeExternalName</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>svc</span><span class=p>.</span><span class=nf>Headless</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// serve NXDOMAIN if no endpoint is able to answer
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=nx>podsCount</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nf>endpointsListFunc</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>eps</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ep</span><span class=p>.</span><span class=nx>Subsets</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=nx>podsCount</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>eps</span><span class=p>.</span><span class=nx>Addresses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>podsCount</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// External service
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>api</span><span class=p>.</span><span class=nx>ServiceTypeExternalName</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>s</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=nx>zonePath</span><span class=p>,</span> <span class=nx>Svc</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Name</span><span class=p>},</span> <span class=s>&#34;/&#34;</span><span class=p>),</span> <span class=nx>Host</span><span class=p>:</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>ExternalName</span><span class=p>,</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>t</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>HostType</span><span class=p>();</span> <span class=nx>t</span> <span class=o>==</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>TypeCNAME</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nx>Key</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=nx>zonePath</span><span class=p>,</span> <span class=nx>Svc</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Name</span><span class=p>},</span> <span class=s>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>services</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>services</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>err</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Endpoint query or headless service
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>svc</span><span class=p>.</span><span class=nf>Headless</span><span class=p>()</span> <span class=o>||</span> <span class=nx>r</span><span class=p>.</span><span class=nx>endpoint</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>endpointsList</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>endpointsList</span> <span class=p>=</span> <span class=nf>endpointsListFunc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>endpointsList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>object</span><span class=p>.</span><span class=nf>EndpointsKey</span><span class=p>(</span><span class=nx>svc</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>)</span> <span class=o>!=</span> <span class=nx>ep</span><span class=p>.</span><span class=nx>Index</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>eps</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ep</span><span class=p>.</span><span class=nx>Subsets</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>addr</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>eps</span><span class=p>.</span><span class=nx>Addresses</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                  <span class=c1>// See comments in parse.go parseRequest about the endpoint handling.
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>endpoint</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=p>!</span><span class=nf>match</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>endpoint</span><span class=p>,</span> <span class=nf>endpointHostname</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>k</span><span class=p>.</span><span class=nx>endpointNameMode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>continue</span>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>eps</span><span class=p>.</span><span class=nx>Ports</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=p>!(</span><span class=nf>matchPortAndProtocol</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>port</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>protocol</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Protocol</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>continue</span>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=nx>s</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Host</span><span class=p>:</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nx>Port</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Port</span><span class=p>),</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=nx>s</span><span class=p>.</span><span class=nx>Key</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=nx>zonePath</span><span class=p>,</span> <span class=nx>Svc</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nf>endpointHostname</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>k</span><span class=p>.</span><span class=nx>endpointNameMode</span><span class=p>)},</span> <span class=s>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=nx>err</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=nx>services</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>services</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>               <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// ClusterIP service
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Ports</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=p>!(</span><span class=nf>matchPortAndProtocol</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>port</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>protocol</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Protocol</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nx>err</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ip</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>ClusterIPs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span><span class=nx>Host</span><span class=p>:</span> <span class=nx>ip</span><span class=p>,</span> <span class=nx>Port</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Port</span><span class=p>),</span> <span class=nx>TTL</span><span class=p>:</span> <span class=nx>k</span><span class=p>.</span><span class=nx>ttl</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nx>Key</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=nx>zonePath</span><span class=p>,</span> <span class=nx>Svc</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Name</span><span class=p>},</span> <span class=s>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>services</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>services</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>services</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到 pod 和 service 逻辑其实差不多，最终都是去 <code>client-go</code> 的 <code>Indexer</code> 缓存里查数据并返回，比如 service 是这样从 Indexer 里拿数据的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>dns</span> <span class=o>*</span><span class=nx>dnsControl</span><span class=p>)</span> <span class=nf>SvcIndex</span><span class=p>(</span><span class=nx>idx</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>svcs</span> <span class=p>[]</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Service</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>os</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dns</span><span class=p>.</span><span class=nx>svcLister</span><span class=p>.</span><span class=nf>ByIndex</span><span class=p>(</span><span class=nx>svcNameNamespaceIndex</span><span class=p>,</span> <span class=nx>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>o</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>os</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>s</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.(</span><span class=o>*</span><span class=nx>object</span><span class=p>.</span><span class=nx>Service</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>svcs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>svcs</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>svcs</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>拿到数据后就组装成 DNS resp 格式的数据返回即可。</p><p>客户端请求数据里面包含了 serviceName、namespace 等信息，Kubernetes 插件就根据这些信息去 Indexer 中查询拿到对应的 endpoint 组装后返回即可。</p><blockquote><p>这也解释了为什么 service 的 dns 记录必须要按照 <code>&lt;podName>.&lt;serviceName>.&lt;namesapce>.svc.cluster.local</code> 这个规范来，因为 coredns 这边就是这样解析的。</p><p>只有按照该规范请求过来，Kubernetes 插件才能从中提取出 podName、serviceName、namespace 等信息，然后才能拿到具体的数据返回。</p></blockquote><h3 id=小结>小结</h3><p>Kubernetes 插件主要在插件启动时启动了 servide、endpoint、pod（根据配置文件可选）的 Controller，然后<strong>复用了 client-go 中的 informer 机制以缓存数据</strong>。</p><p>处理 DNS 解析请求时，首先根据请求数据解析出 service、namespace、pod 等信息，然后<strong>从 client-go 中的 Indexer 本地缓存里拿数据组装后响应给客户端</strong>。</p><h2 id=3-pod-如何知道要把请求发给-coredns>3. Pod 如何知道要把请求发给 CoreDNS</h2><h3 id=pod-dnsconfig>Pod DNSConfig</h3><p>首先我们看一下 pod 里的 dns 配置。</p><p>先随便启动一个 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>kubectl create deployment nginx --image nginx
</span></span></code></pre></div><p>等到 pod 启动后，用 exec 命令看一下 pod 里的 dnsConfig：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@test ~<span class=o>]</span><span class=c1># k get po</span>
</span></span><span class=line><span class=cl>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>nginx-85b98978db-mttqh   1/1     Running   <span class=m>0</span>          77s
</span></span><span class=line><span class=cl><span class=o>[</span>root@test ~<span class=o>]</span><span class=c1># kubectl exec -it nginx-85b98978db-mttqh -- cat /etc/resolv.conf</span>
</span></span><span class=line><span class=cl>search default.svc.cluster.local svc.cluster.local cluster.local
</span></span><span class=line><span class=cl>nameserver 10.96.0.10
</span></span><span class=line><span class=cl>options ndots:5
</span></span></code></pre></div><p>可以看到 pod 的 namaserver 配置的是 10.96.0.10,，而这个 IP 正好就是 CoreDNS Service 的 ClusterIP</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@test ~<span class=o>]</span><span class=c1># kubectl -n kube-system get svc kube-dns</span>
</span></span><span class=line><span class=cl>NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>                                    AGE
</span></span><span class=line><span class=cl>kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   5d20h
</span></span></code></pre></div><p>也就是说根据这个配置，pod 中的 dns 请求会发给 CoreDNS。</p><p>那么问题来了，这个配置是哪儿来的呢？</p><h3 id=配置来源>配置来源</h3><h4 id=dnspolicy>dnsPolicy</h4><p>实际上 Pod 都可以指定一个叫做 <a href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy target=_blank rel="noopener noreffer">dnsPolicy</a> 的字段，用于配置 Pod 里的 DNS 策略。</p><p>DNS 策略可以逐个 Pod 来设定。目前 Kubernetes 支持以下特定 Pod 的 DNS 策略。 这些策略可以在 Pod 规约中的 <code>dnsPolicy</code> 字段设置：</p><ul><li>&ldquo;<code>Default</code>&rdquo;: Pod 从运行所在的节点继承名称解析配置。</li><li>&ldquo;<code>ClusterFirst</code>&rdquo;: 与配置的集群域后缀不匹配的任何 DNS 查询（例如 &ldquo;<a href=https://www.kubernetes.io target=_blank rel="noopener noreffer">www.kubernetes.io</a>&rdquo;） 都会由 DNS 服务器转发到上游名称服务器。</li><li>&ldquo;<code>ClusterFirstWithHostNet</code>&rdquo;: 对于以 hostNetwork 方式运行的 Pod，应将其 DNS 策略显式设置为 &ldquo;<code>ClusterFirstWithHostNet</code>"。否则，以 hostNetwork 方式和 <code>"ClusterFirst"</code> 策略运行的 Pod 将会做出回退至 <code>"Default"</code> 策略的行为。</li><li>&ldquo;<code>None</code>&rdquo;: 此设置允许 Pod 忽略 Kubernetes 环境中的 DNS 设置。Pod 会使用其 <code>dnsConfig</code> 字段所提供的 DNS 设置。</li></ul><h4 id=dnsconfig>dnsConfig</h4><p>pod 的 DNS 配置可让用户对 Pod 的 DNS 设置进行更多控制。</p><p><code>dnsConfig</code> 字段是可选的，它可以与任何 <code>dnsPolicy</code> 设置一起使用。 但是，当 Pod 的 <code>dnsPolicy</code> 设置为 &ldquo;<code>None</code>&rdquo; 时，必须指定 <code>dnsConfig</code> 字段。</p><p>用户可以在 <code>dnsConfig</code> 字段中指定以下属性：</p><ul><li><code>nameservers</code>：将用作于 Pod 的 DNS 服务器的 IP 地址列表。 最多可以指定 3 个 IP 地址。当 Pod 的 <code>dnsPolicy</code> 设置为 &ldquo;<code>None</code>&rdquo; 时， 列表必须至少包含一个 IP 地址，否则此属性是可选的。 所列出的服务器将合并到从指定的 DNS 策略生成的基本名称服务器，并删除重复的地址。</li><li><code>searches</code>：用于在 Pod 中查找主机名的 DNS 搜索域的列表。此属性是可选的。 指定此属性时，所提供的列表将合并到根据所选 DNS 策略生成的基本搜索域名中。 重复的域名将被删除。Kubernetes 最多允许 6 个搜索域。</li><li><code>options</code>：可选的对象列表，其中每个对象可能具有 <code>name</code> 属性（必需）和 <code>value</code> 属性（可选）。 此属性中的内容将合并到从指定的 DNS 策略生成的选项。 重复的条目将被删除。</li></ul><p>Demo 如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-YAML data-lang=YAML><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dns-example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;None&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nameservers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>192.0.2.1</span><span class=w> </span><span class=c># 这是一个示例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>searches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ns1.svc.cluster-domain.example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>my.dns.search.suffix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>options</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ndots</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>edns0</span><span class=w>
</span></span></span></code></pre></div><p><strong>也就是说只要我们将 dnsPolicy 配置为 None，然后就通过 dnsConfig 来自定义 pod 里的 /etc/resolv.conf 文件内容了。</strong></p><p>当然了，一般这个我们都是用的默认值，不会去配置的。也就是说刚才我们在 nginx pod 里看到的数据是默认值，那么这些默认值是哪儿来的呢？</p><h3 id=kubelet>Kubelet</h3><p>实际上是 kubelet 帮我们配置的。</p><p>查看一下 kubelet 的配置文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@test ~<span class=o>]</span><span class=c1># cat /var/lib/kubelet/config.yaml</span>
</span></span><span class=line><span class=cl>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span class=line><span class=cl>authentication:
</span></span><span class=line><span class=cl>  anonymous:
</span></span><span class=line><span class=cl>    enabled: <span class=nb>false</span>
</span></span><span class=line><span class=cl>  webhook:
</span></span><span class=line><span class=cl>    cacheTTL: 0s
</span></span><span class=line><span class=cl>    enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  x509:
</span></span><span class=line><span class=cl>    clientCAFile: /etc/kubernetes/pki/ca.crt
</span></span><span class=line><span class=cl>authorization:
</span></span><span class=line><span class=cl>  mode: Webhook
</span></span><span class=line><span class=cl>  webhook:
</span></span><span class=line><span class=cl>    cacheAuthorizedTTL: 0s
</span></span><span class=line><span class=cl>    cacheUnauthorizedTTL: 0s
</span></span><span class=line><span class=cl>cgroupDriver: systemd
</span></span><span class=line><span class=cl>clusterDNS:
</span></span><span class=line><span class=cl>- 10.96.0.10
</span></span><span class=line><span class=cl>clusterDomain: cluster.local
</span></span><span class=line><span class=cl>cpuManagerReconcilePeriod: 0s
</span></span><span class=line><span class=cl>evictionPressureTransitionPeriod: 0s
</span></span><span class=line><span class=cl>fileCheckFrequency: 0s
</span></span><span class=line><span class=cl>healthzBindAddress: 127.0.0.1
</span></span><span class=line><span class=cl>healthzPort: <span class=m>10248</span>
</span></span><span class=line><span class=cl>httpCheckFrequency: 0s
</span></span><span class=line><span class=cl>imageGCHighThresholdPercent: <span class=m>85</span>
</span></span><span class=line><span class=cl>imageGCLowThresholdPercent: <span class=m>80</span>
</span></span><span class=line><span class=cl>imageMinimumGCAge: 2m0s
</span></span><span class=line><span class=cl>kind: KubeletConfiguration
</span></span><span class=line><span class=cl>logging:
</span></span><span class=line><span class=cl>  flushFrequency: <span class=m>0</span>
</span></span><span class=line><span class=cl>  options:
</span></span><span class=line><span class=cl>    json:
</span></span><span class=line><span class=cl>      infoBufferSize: <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>  verbosity: <span class=m>0</span>
</span></span><span class=line><span class=cl>memorySwap: <span class=o>{}</span>
</span></span><span class=line><span class=cl>nodeStatusReportFrequency: 0s
</span></span><span class=line><span class=cl>nodeStatusUpdateFrequency: 0s
</span></span><span class=line><span class=cl>rotateCertificates: <span class=nb>true</span>
</span></span><span class=line><span class=cl>runtimeRequestTimeout: 0s
</span></span><span class=line><span class=cl>shutdownGracePeriod: 0s
</span></span><span class=line><span class=cl>shutdownGracePeriodCriticalPods: 0s
</span></span><span class=line><span class=cl>staticPodPath: /etc/kubernetes/manifests
</span></span><span class=line><span class=cl>streamingConnectionIdleTimeout: 0s
</span></span><span class=line><span class=cl>syncFrequency: 3s
</span></span><span class=line><span class=cl>volumeStatsAggPeriod: 1m0s
</span></span></code></pre></div><p>里面正好有一个叫做 clusterDNS 的字段，值刚好也是 10.96.0.10。</p><p>到这里基本可以证实我们的猜想了，pod 里的这个值是由 kubelet 配置的，不过还是翻下源码确认一下。</p><p>相关代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// pkg/kubelet/network/dns/dns.go#430
</span></span></span><span class=line><span class=cl><span class=c1>// SetupDNSinContainerizedMounter replaces the nameserver in containerized-mounter&#39;s rootfs/etc/resolv.conf with kubelet.ClusterDNS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Configurer</span><span class=p>)</span> <span class=nf>SetupDNSinContainerizedMounter</span><span class=p>(</span><span class=nx>mounterPath</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>resolvePath</span> <span class=o>:=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>TrimSuffix</span><span class=p>(</span><span class=nx>mounterPath</span><span class=p>,</span> <span class=s>&#34;/mounter&#34;</span><span class=p>),</span> <span class=s>&#34;rootfs&#34;</span><span class=p>,</span> <span class=s>&#34;etc&#34;</span><span class=p>,</span> <span class=s>&#34;resolv.conf&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>dnsString</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>dns</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>c</span><span class=p>.</span><span class=nx>clusterDNS</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>dnsString</span> <span class=p>=</span> <span class=nx>dnsString</span> <span class=o>+</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;nameserver %s\n&#34;</span><span class=p>,</span> <span class=nx>dns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ResolverConfig</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ResolverConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Could not open resolverConf file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>         <span class=nx>_</span><span class=p>,</span> <span class=nx>hostSearch</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>parseResolvConf</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error for parsing the resolv.conf file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>dnsString</span> <span class=p>=</span> <span class=nx>dnsString</span> <span class=o>+</span> <span class=s>&#34;search&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>search</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>hostSearch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=nx>dnsString</span> <span class=p>=</span> <span class=nx>dnsString</span> <span class=o>+</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34; %s&#34;</span><span class=p>,</span> <span class=nx>search</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>dnsString</span> <span class=p>=</span> <span class=nx>dnsString</span> <span class=o>+</span> <span class=s>&#34;\n&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>WriteFile</span><span class=p>(</span><span class=nx>resolvePath</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>dnsString</span><span class=p>),</span> <span class=mo>0600</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Could not write dns nameserver in the file&#34;</span><span class=p>,</span> <span class=s>&#34;path&#34;</span><span class=p>,</span> <span class=nx>resolvePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>内容也很简单，就是在启动 pod，mount rootfs 的时候，根据 kubelet 的 config 内容生成一个 /etc/resolv.conf 并替换进去。</p><p>至此，pod 中的 DNS 请求为什么会发给 CoreDNS 就很清晰了。</p><h3 id=为什么是-1096010>为什么是 10.96.0.10</h3><p>不过可能大家还有一个疑问，怎么 coredns 的 clusterIP 每次都是 10.96.0.10 呢。实际上这只是 kubeadm 里的一个默认值罢了。</p><blockquote><p>因为现在大家都是使用 kubeadm 来搭的集群，所以创建出来发现 coredns 的 clusterIP 每次都是 10.96.0.10 。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// cmd/kubeadm/app/componentconfigs/kubelet.go#129
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>kc</span> <span class=o>*</span><span class=nx>kubeletConfig</span><span class=p>)</span> <span class=nf>Default</span><span class=p>(</span><span class=nx>cfg</span> <span class=o>*</span><span class=nx>kubeadmapi</span><span class=p>.</span><span class=nx>ClusterConfiguration</span><span class=p>,</span> <span class=nx>_</span> <span class=o>*</span><span class=nx>kubeadmapi</span><span class=p>.</span><span class=nx>APIEndpoint</span><span class=p>,</span> <span class=nx>nodeRegOpts</span> <span class=o>*</span><span class=nx>kubeadmapi</span><span class=p>.</span><span class=nx>NodeRegistrationOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=kd>const</span> <span class=nx>kind</span> <span class=p>=</span> <span class=s>&#34;KubeletConfiguration&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>FeatureGates</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>FeatureGates</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>StaticPodPath</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>StaticPodPath</span> <span class=p>=</span> <span class=nx>kubeadmapiv1</span><span class=p>.</span><span class=nx>DefaultManifestsDir</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>StaticPodPath</span> <span class=o>!=</span> <span class=nx>kubeadmapiv1</span><span class=p>.</span><span class=nx>DefaultManifestsDir</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>warnDefaultComponentConfigValue</span><span class=p>(</span><span class=nx>kind</span><span class=p>,</span> <span class=s>&#34;staticPodPath&#34;</span><span class=p>,</span> <span class=nx>kubeadmapiv1</span><span class=p>.</span><span class=nx>DefaultManifestsDir</span><span class=p>,</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>StaticPodPath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>clusterDNS</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>   <span class=nx>dnsIP</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>constants</span><span class=p>.</span><span class=nf>GetDNSIP</span><span class=p>(</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>Networking</span><span class=p>.</span><span class=nx>ServiceSubnet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>clusterDNS</span> <span class=p>=</span> <span class=nx>kubeadmapiv1</span><span class=p>.</span><span class=nx>DefaultClusterDNSIP</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>clusterDNS</span> <span class=p>=</span> <span class=nx>dnsIP</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDNS</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDNS</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>clusterDNS</span><span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDNS</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span> <span class=o>||</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDNS</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=nx>clusterDNS</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>warnDefaultComponentConfigValue</span><span class=p>(</span><span class=nx>kind</span><span class=p>,</span> <span class=s>&#34;clusterDNS&#34;</span><span class=p>,</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>clusterDNS</span><span class=p>},</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDNS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDomain</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDomain</span> <span class=p>=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>Networking</span><span class=p>.</span><span class=nx>DNSDomain</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>Networking</span><span class=p>.</span><span class=nx>DNSDomain</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDomain</span> <span class=o>!=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>Networking</span><span class=p>.</span><span class=nx>DNSDomain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>warnDefaultComponentConfigValue</span><span class=p>(</span><span class=nx>kind</span><span class=p>,</span> <span class=s>&#34;clusterDomain&#34;</span><span class=p>,</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>Networking</span><span class=p>.</span><span class=nx>DNSDomain</span><span class=p>,</span> <span class=nx>kc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClusterDomain</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// ....省略 
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=p>}</span>
</span></span></code></pre></div><p>如果我们指定了 service 子网时，kubeadm 会根据子网拿到第一个 IP 作为 coreDNS 的 clusterIP，默认子网就是 10.96.0.10/12 ，所以我们拿到的 IP 也是 10.96.0.10。如果解析失败那就直接用 10.96.0.10：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=nx>DefaultServicesSubnet</span> <span class=p>=</span> <span class=s>&#34;10.96.0.0/12&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>DefaultClusterDNSIP</span> <span class=p>=</span> <span class=s>&#34;10.96.0.10&#34;</span>
</span></span></code></pre></div><h2 id=4-小结>4. 小结</h2><p>相信到这里的时候，文章开头的两个问题大家也有了答案：</p><ul><li><p><strong>1）CoreDNS 是如何解析请求的</strong></p><ul><li>CoreDNS 收到的请求由 kubernetes 插件处理</li><li>数据来源：该插件借助 client-go 中的 Informer 机制，将所有 service、endpoint、pod 缓存到本地的 Indexer 缓存里</li><li>处理逻辑：DNS 请求时客户端按照<code>&lt;podName>.&lt;serviceName>.&lt;namesapce>.svc.cluster.local</code>规范发起请求，Kubernetes插件则按照该规范解析出 podName、serviceName、namespace 等信息，然后 从 Indexer 本地缓存里查询到具体数据并返回结果给客户端</li></ul></li><li><p><strong>2）Pod 中的 DNS 配置，Pod 怎么知道该向 CoreDNS 发送解析请求</strong></p><ul><li><p>pod 里的 /etc/resolv.conf 中 nameserver 指向 10.96.0.10（coreDNS 默认 clusterIP），因此 pod 中的 DNS 请求会发送给 CoreDNS</p></li><li><p>pod 中的 /etc/resolv.conf 由 kubelet 启动 pod 时根据 clusterDNS 字段生成</p></li><li><p>Kubelet 配置中的 clusterDNS 字段来源于 kubelet 配置文件 /var/lib/kubelet/config.yaml</p></li><li><p>/var/lib/kubelet/config.yaml 配置文件由 kubeadm 生成</p></li><li><p>kubeadm 中的 clusterDNS 地址则是从 service 子网提取出来的，如果用户在 kubeadm init 时没有指定则使用默认值 <code>10.96.0.10/12</code>,此时提取到的 clusterDNS 就是 10.96.0.10。</p><ul><li>如果是用别的方式搭建的集群，这里可能会有所不同，不过最终都是根据 service 子网提取一个 ip 写入 kubelet 配置文件</li><li>至于为什么访问 10.96.0.10 就访问到 CoreDNS 这个就是 service 的内容了,具体可以参考这篇文章 <a href=https://www.lixueduan.com/posts/kubernetes/04-service-core target=_blank rel="noopener noreffer">Kubernetes教程(四)&mdash;Service核心原理</a></li></ul></li></ul></li></ul><p>整个流程大致如下：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../../../img/kubernetes/dns/k8s-pod-dns-workflow.png data-srcset="../../../img/kubernetes/dns/k8s-pod-dns-workflow.png, ../../../img/kubernetes/dns/k8s-pod-dns-workflow.png 1.5x, ../../../img/kubernetes/dns/k8s-pod-dns-workflow.png 2x" data-sizes=auto alt=../../../img/kubernetes/dns/k8s-pod-dns-workflow.png title=../../../img/kubernetes/dns/k8s-pod-dns-workflow.png></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-25</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.lixueduan.com/posts/kubernetes/16-kubedns-workflow/ data-title="Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理" data-hashtags=Kubernetes><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://www.lixueduan.com/posts/kubernetes/16-kubedns-workflow/ data-hashtag=Kubernetes><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.lixueduan.com/posts/kubernetes/16-kubedns-workflow/ data-title="Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://www.lixueduan.com/posts/kubernetes/16-kubedns-workflow/ data-title="Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://www.lixueduan.com/posts/kubernetes/16-kubedns-workflow/ data-title="Kubernetes教程(十六)---从 Service DNS 记录到 IP 地址，KubeDNS 工作原理"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kubernetes/>Kubernetes</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/cloudnative/01-metallb/ class=prev rel=prev title="裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程</a>
<a href=/posts/docker/11-use-ssh-private-key-in-docker-build/ class=next rel=next title="Docker教程(十一)---如何在 Docker Build 时使用 SSH 私钥进行认证">Docker教程(十一)---如何在 Docker Build 时使用 SSH 私钥进行认证<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/lixd target=_blank>意琦行</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a rel="license external nofollow noopener noreffer" href=https://beian.miit.gov.cn/ target=_blank>渝ICP备20005680号-1</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.480e58b2c2a8605d406f34667e92ff8f1ae50cfee5b653bead570f004839a983.js integrity="sha256-SA5YssKoYF1AbzRmfpL/jxrlDP7ltlO+rVcPAEg5qYM="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-FL23FNP7CM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FL23FNP7CM" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b7c98449a6edf8492a8f3404e6d06a0",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7693630257897132" crossorigin=anonymous></script></body></html>